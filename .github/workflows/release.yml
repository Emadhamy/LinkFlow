name: ğŸ‰ Release APK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ§¹ Clean workspace
        run: |
          mkdir -p /tmp/release-build
          cd /tmp/release-build
      
      - name: ğŸ“± Install Cordova
        run: npm install -g cordova
      
      - name: ğŸ“ Create Cordova project
        run: |
          cd /tmp/release-build
          cordova create cordova-release com.linkflow.app "LinkFlow"
          cd cordova-release
          cordova platform add android
      
      - name: ğŸ“ Copy application files
        run: |
          cp ${{ github.workspace }}/index.html /tmp/release-build/cordova-release/www/
          cp ${{ github.workspace }}/manifest.json /tmp/release-build/cordova-release/www/
          cp ${{ github.workspace }}/icon.svg /tmp/release-build/cordova-release/www/
          cp ${{ github.workspace }}/sw.js /tmp/release-build/cordova-release/www/
          cp ${{ github.workspace }}/config.xml /tmp/release-build/cordova-release/www/
          cp ${{ github.workspace }}/download.html /tmp/release-build/cordova-release/www/ 2>/dev/null || true
      
      - name: ğŸ”¨ Build Release APK
        working-directory: /tmp/release-build/cordova-release
        run: cordova build android --release
      
      - name: ğŸ“ Find Release APK
        id: find_release
        run: |
          RELEASE_APK=$(find /tmp/release-build/cordova-release -name "*release*.apk" -type f | head -1)
          
          if [ -z "$RELEASE_APK" ]; then
            RELEASE_APK="/tmp/release-build/cordova-release/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          fi
          
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_SIZE=$(du -h "$RELEASE_APK" | cut -f1)
            echo "âœ… Release APK: $RELEASE_APK ($RELEASE_SIZE)"
            echo "apk_path=$RELEASE_APK" >> $GITHUB_OUTPUT
            echo "apk_size=$RELEASE_SIZE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Release APK not found"
            echo "apk_path=" >> $GITHUB_OUTPUT
            echo "apk_size=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¦ Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: |
            ${{ steps.find_release.outputs.apk_path }}
            LICENSE
          draft: false
          prerelease: false
          body: |
            # ğŸ‰ LinkFlow Release
            
            **Version:** ${{ github.ref_name }}
            
            ## ğŸ“± ØªØ·Ø¨ÙŠÙ‚ LinkFlow
            
            Ø§Ø¨Ø¹Øª.. Ø³Ø¬Ù„.. Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªØ³ÙŠÙ
            
            Smart WhatsApp Contact Manager
            
            ## ğŸ“¦ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            
            - **LinkFlow APK** - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª
            
            ## ğŸš€ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
            
            1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù APK
            2. Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
            3. Ø§Ù‚Ø¨Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª
            4. Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù€ LinkFlow! ğŸ‰
            
            ## âœ¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª
            
            - ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø±ÙˆØ§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø³Ø±ÙŠØ¹Ø©
            - ğŸ’¾ Ø­ÙØ¸ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…ÙØ¶Ù„Ø©
            - ğŸ“‹ Ù‚ÙˆØ§Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø³Ø¨Ù‚Ø©
            - ğŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ ÙˆÙØ§ØªØ­
            - ğŸŒ Ø¯Ø¹Ù… Ø¹Ø±Ø¨ÙŠ ÙƒØ§Ù…Ù„ (RTL)
            - ğŸ“´ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ±Ù†Øª (PWA)
            
            ## ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            
            - ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù€ GitHub Actions
            - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¢Ù…Ù†Ø© ÙˆØ®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            - ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø±Ø§Øª Android
            
            ---
            
            **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** ${{ github.event.repository.updated_at }}
            **Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:** LinkFlow Team
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¢ Build Summary
        run: |
          echo "âœ… Release Build Complete!"
          echo ""
          echo "ğŸ“¦ Release Information:"
          echo "  Version: ${{ github.ref_name }}"
          echo "  APK File: ${{ steps.find_release.outputs.apk_path }}"
          echo "  APK Size: ${{ steps.find_release.outputs.apk_size }}"
          echo ""
          echo "ğŸ“¥ Download: GitHub Releases"
          echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
